groups:
  - name: netapp-snapmirror
    rules:
    # NOTE:
    #
    # netapp_snapmirror_labels: Local destinations ONLY (from 'snapmirror show' - more snapmirror details).
    # netapp_snapmirror_endpoint_labels: Local AND remote destinations (from 'snapmirror list-destinations' - endpoints only no details).
    #
    # Enrich netapp_snapmirror_labels with destination_cluster,
    # then with share_id, share_name and project_id.
    - record: netapp_snapmirror_labels:enhanced
      expr: |
        netapp_snapmirror_labels{app="netapp-harvest-exporter-manila"} 
        * on (app, source_vserver, source_volume) group_left(project_id, share_id, share_name)
        label_replace (
        label_replace (
          max by (app, filer, project_id, share_id, share_name, svm, volume)
            (netapp_volume_labels{volume=~"share.*"}),
          "source_volume", "$1", "volume", "(.*)"),
          "source_vserver", "$1", "svm", "(.*)")
        * on (app, filer, destination_volume) group_left(destination_cluster)
        label_replace (
        label_replace (
          max by (app, filer, svm, volume) (netapp_volume_labels{volume=~"share.*"}),
          "destination_cluster", "$1", "filer", "(.*)"),
          "destination_volume", "$1", "volume", "(.*)")



    # Enrich the enhanced metrics netapp_snapmirror_labels:enhanced further
    # with share_id, share_name and project_id.
    #
    # NOTE: All snapmirror have destinations in local region, not all have
    # local sources. We have to separte the enhancement into two separate
    # rules. There will be some metrics enhanced with only
    # "destination_cluster", and others with "source_cluster", "share_id" and
    # etc in addition.
    - record: netapp_snapmirror_labels:enhanced
      expr: |
        (netapp_snapmirror_labels unless on (source_volume)
            label_replace(netapp_volume_labels, "source_volume", "$1", "volume", "(.*)"))
        * on (filer, destination_volume) group_left(destination_cluster) 
        label_replace(label_replace(
          netapp_volume_labels{volume=~"share.*"},
          "destination_volume", "$1", "volume", "(.*)"),
          "destination_cluster", "$1", "filer", "(.*)")

    # In comparison to netapp_snapmirror_labels,
    # netapp_snapmirror_endpoint_labels includes snapmirrors with destinations
    # in remote region. But it doesn't have detailed info about snapmirror,
    # like healthy, status and etc.
    - record: netapp_snapmirror_endpoint_labels:enhanced
      expr: |
        netapp_snapmirror_endpoint_labels
        * on (source_vserver, source_volume) group_left (source_cluster, project_id, share_id, share_name)
        label_replace(
        label_replace(
        label_replace(
          max by (filer, project_id, share_id, share_name, svm, volume)
            (netapp_volume_labels{app="netapp-harvest-exporter-manila", volume=~"share.*"}),
          "source_volume", "$1", "volume", "(.*)"),
          "source_vserver", "$1", "svm", "(.*)"),
          "source_cluster", "$1", "filer", "(.*)")

          
    # cross region snapmirror
    # i.e. source_volume can't be found in the same region
    # netapp_snapmirror_labels unless on(source_volume) label_replace(netapp_volume_labels, "source_volume", "$1", "volume", "(.*)")
 
    #+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    # maia
    #+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    # - record: netapp_snapmirror_labels:maia
    #   expr: |
    #     sum by (
    #       availability_zone, project_id, share_id, share_name,
    #       destination_cluster, destination_node, destination_volume, destination_vserver,
    #       source_cluster, source_volume, source_vserver,
    #       derived_relationship_type, group_type, healthy, last_transfer_error,
    #       last_transfer_type, local,  region, policy_type, protectedBy,
    #       protectionSourceType, relationship_id, relationship_status,
    #       relationship_type, schedule, unhealthy_reason
    #     ) netapp_snapmirror_labels:filled
    #
    # - record: netapp_snapmirror_endpoint_labels
    #   expr: |
    #     netapp_snapmirror_endpoint_labels
    #     * on (source_volume) group_left(source_cluster, share_id, share_name, project_id)
    #     label_replace (
    #     label_replace (
    #       max by (filer, project_id, share_id, share_name, svm, volume)
    #         (netapp_volume_labels{app="netapp-harvest-exporter-manila", volume=~"share.*"}),
    #       "source_cluster", "$1", "filer", "(.*)"),
    #       "source_volume", "$1", "volume", "(.*)")


