{{- if .Values.deployment.enable }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: etcd-kcp
  namespace: {{ .Values.namespace | default "kube-system" }}
  labels:
    {{- include "chart.labels" . | nindent 4 }}
    etcd-kcp: backup
spec:
  replicas:  {{ .Values.deployment.replicas }}
  selector:
    matchLabels:
      {{- include "chart.selectorLabels" . | nindent 6 }}
      etcd-kcp: backup
  template:
    metadata:
      labels:
        {{- include "chart.labels" . | nindent 8 }}
        etcd-kcp: backup
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: kubernetes.metal.cloud.sap/role
                operator: In
                values:
                - runtime-controlplane
      containers:
        - name: manager
          image: {{ .Values.deployment.container.image.repository }}:{{ .Values.deployment.container.image.tag }}
          command:
            - /etcdbrctl
          args:
            - server
            - '--schedule=0 4 * * *'
            - '--data-dir=/var/lib/etcd/new.etcd'
            - '--restoration-temp-snapshots-dir=/var/lib/etcd/restoration.temp'
            - '--snapstore-temp-directory=/var/lib/etcd/temp'
            - '--endpoints=https://etcd-kcp.kube-system.svc.cluster.local:2379'
            - '--storage-provider=S3'
            - '--enable-snapshot-lease-renewal=true'
            - '--full-snapshot-lease-name=etcd-kcp-full-snap'
            - '--delta-snapshot-lease-name=etcd-kcp-delta-snap'
            - '--delta-snapshot-period=5m0s'
            - '--delta-snapshot-memory-limit=104857600'
            - '--garbage-collection-period=12h0m0s'
            - '--garbage-collection-policy=Exponential'
            - '--cacert=/etc/kubernetes/pki/etcd/ca.crt'
            - '--cert=/etc/kubernetes/pki/apiserver-etcd-client.crt'
            - '--key=/etc/kubernetes/pki/apiserver-etcd-client.key'
            - '--insecure-transport=false'
            - '--insecure-skip-tls-verify=true'
            - '--auto-compaction-mode=periodic'
            - '--auto-compaction-retention=30m'
            - '--compress-snapshots=true'
            - '--compression-policy=gzip'
            - '--etcd-snapshot-timeout=15m'
            - '--etcd-defrag-timeout=15m'
            - '--etcd-connection-timeout=5m'
            - '--defragmentation-schedule=0 3 */3 * *'
            - '--garbage-collection-policy=Exponential'
            - '--garbage-collection-period=12h0m0s'
            - '--store-prefix={{ .Values.clusterName }}'
            - '--enable-member-lease-renewal=true'
            - '--embedded-etcd-quota-bytes=8589934592'
            - '--k8s-heartbeat-duration=10s'
          ports:
          - name: server
            containerPort: 8080
            protocol: TCP
          env:
            - name: AWS_APPLICATION_CREDENTIALS
              value: /etc/aws/credentials
            - name: STORAGE_CONTAINER
              value: etcd-kcp-backup
            - name: POD_NAME
              value: etcd-kcp
              # valueFrom:
              #   fieldRef:
              #     apiVersion: v1
              #     fieldPath: metadata.name
            - name: POD_NAMESPACE
              value: kube-system
          resources:
            {{- toYaml .Values.deployment.container.resources | nindent 12 }}
          securityContext:
            {{- toYaml .Values.deployment.container.securityContext | nindent 12 }}
          volumeMounts:
            - name: etcd-config
              mountPath: /var/etcd/config
            - name: etcd-data
              mountPath: /var/lib/etcd
            - name: pki-certs
              readOnly: true
              mountPath: /etc/kubernetes/pki
            - name: aws-credentials
              readOnly: true
              mountPath: /etc/aws/credentials
      securityContext:
        {{- toYaml .Values.deployment.securityContext | nindent 8 }}
      serviceAccountName: {{ .Values.deployment.serviceAccountName }}
      terminationGracePeriodSeconds: 30
      priorityClassName: system-node-critical
      priority: 2000001000
      tolerations:
        - operator: Exists
          effect: NoExecute
      volumes:
        - name: etcd-config
          configMap:
            name: etcd-kcp
        - name: etcd-data
          hostPath:
            path: /var/lib/etcd
            type: DirectoryOrCreate
        - name: pki-certs
          hostPath:
            path: /etc/kubernetes/pki
            type: DirectoryOrCreate
        - name: aws-credentials
          secret:
            secretName: etcd-kcp-aws
            items:
              - key: access-key-id
                path: accessKeyID
              - key: region
                path: region
              - key: secret-access-key
                path: secretAccessKey
            defaultMode: 420
{{- end }}
