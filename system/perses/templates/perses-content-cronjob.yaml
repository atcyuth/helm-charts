apiVersion: batch/v1
kind: CronJob
metadata:
  name: perses-content-sync
  namespace: perses  # Adjust namespace as needed
spec:
  schedule: "*/3 * * * *"  # Every 3 minutes
  concurrencyPolicy: Replace  # Replace running job if it's still running
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: OnFailure
          containers:
          - name: content-sync
            image:keppel.eu-de-1.cloud.sap/ccloud-gcr-mirror/go-containerregistry/crane:debug
            command: ["/bin/sh"]
            args:
              - -c
              - |
                set -e
                echo "Starting content sync at $(date)"
                
                # Create temp directory for extraction
                TEMP_DIR="/tmp/perses-extract"
                mkdir -p "$TEMP_DIR"
                
                # Pull and extract the OCI artifact using crane
                echo "Pulling image: keppel.eu-de-1.cloud.sap/ccloud/perses-dashboards:v0.1.0"
                crane export keppel.eu-de-1.cloud.sap/ccloud/perses-dashboards:v0.1.0 - | tar -xf - -C "$TEMP_DIR"
                
                # Clear existing content in PVC (optional - remove if you want to keep old files)
                echo "Clearing existing content..."
                rm -rf /etc/perses/provisioning/* || true
                
                # Copy extracted content to PVC
                echo "Copying content to PVC..."
                cp -r "$TEMP_DIR/perses-content"/* /etc/perses/provisioning/
                
                # Set proper permissions
                chmod -R 644 /etc/perses/provisioning/*.json || true
                chmod -R 755 /etc/perses/provisioning/*/  || true
                
                # List copied files for verification
                echo "Content successfully synced. Files in PVC:"
                find /etc/perses/provisioning -type f -name "*.json" | head -10
                echo "Total JSON files: $(find /etc/perses/provisioning -name "*.json" | wc -l)"
                
                # Cleanup
                rm -rf "$TEMP_DIR"
                echo "Content sync completed at $(date)"
            
            volumeMounts:
            - name: perses-content-volume
              mountPath: /etc/perses/provisioning
            resources:
              requests:
                memory: "128Mi"
                cpu: "100m"
              limits:
                memory: "256Mi"
                cpu: "200m"
          volumes:
          - name: perses-content-volume
            persistentVolumeClaim:
              claimName: perses-content-pvc